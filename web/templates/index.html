<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>toolTruyen - Web UI</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <header>
      <div class="logo-area">
        <i class="fas fa-book-reader fa-2x"></i>
        <div>
          <h1>toolTruyen</h1>
          <p class="subtitle">Premium Novel Downloader</p>
        </div>
      </div>
    </header>

    <main>
      <div class="input-card">
        <label for="novelUrl">Link truy·ªán (trang danh s√°ch ch∆∞∆°ng ho·∫∑c trang truy·ªán):</label>
        <div class="input-group">
          <input id="novelUrl" type="text" placeholder="https://truyenwikidich.net/truyen/..." />
          <button id="loadChaptersBtn" class="primary-btn"><i class="fas fa-sync-alt"></i> Load chapters</button>
        </div>
      </div>

      <div class="stats-card" id="statsCard" style="display:none;">
        <div class="stat-item">
          <span class="stat-label">T·ªïng ch∆∞∆°ng</span>
          <span class="stat-value" id="totalCount">0</span>
        </div>
        <div class="selection-area">
          <label>Ch·ªçn kho·∫£ng ch∆∞∆°ng t·∫£i v·ªÅ</label>
          <div class="select-group">
            <select id="startSel"></select>
            <span class="to-label">ƒë·∫øn</span>
            <select id="endSel"></select>
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <button id="startBtn" class="success-btn" disabled><i class="fas fa-download"></i> B·∫Øt ƒë·∫ßu t·∫£i</button>
        <button id="stopBtn" class="danger-btn" disabled><i class="fas fa-stop"></i> D·ª´ng l·∫°i</button>
        <button id="downloadFinishedBtn" class="primary-btn" style="display:none;"><i class="fas fa-file-export"></i> T·∫£i v·ªÅ file k·∫øt qu·∫£</button>
        <button id="clearLogBtn" class="secondary-btn"><i class="fas fa-trash-alt"></i> X√≥a Log</button>
      </div>

      <section class="log-section">
        <div class="section-header">
          <h2><i class="fas fa-terminal"></i> Ti·∫øn tr√¨nh th·ª±c hi·ªán</h2>
          <span id="jobStatus" class="badge">S·∫µn s√†ng</span>
        </div>
        <div id="log" class="log-container"></div>
      </section>
    </main>

    <footer>
      <p>Made with <i class="fas fa-heart" style="color:#ff4d4d"></i> for truyenwikidich users</p>
      <small>v2.0.0 &copy; 2026 thanhtrug</small>
    </footer>
  </div>

<script>
let currentJob = null;
let pollTimer = null;
let downloadUrl = null;

function log(msg){
  const el = document.getElementById('log');
  const line = document.createElement('div');
  line.className = 'log-line';
  
  if(msg.includes('‚ùå')) line.classList.add('log-error');
  if(msg.includes('‚úÖ')) line.classList.add('log-success');
  if(msg.includes('‚ÑπÔ∏è')) line.classList.add('log-info');
  if(msg.includes('üîÑ')) line.classList.add('log-process');
  
  line.innerHTML = `<span class="timestamp">${new Date().toLocaleTimeString()}</span> ${msg}`;
  el.appendChild(line);
  el.scrollTop = el.scrollHeight;
}

function setStatus(text, type='default'){
  const badge = document.getElementById('jobStatus');
  badge.textContent = text;
  badge.className = 'badge ' + type;
}

document.getElementById('downloadFinishedBtn').addEventListener('click', () => {
  if(downloadUrl) window.location.href = downloadUrl;
});

document.getElementById('loadChaptersBtn').addEventListener('click', async ()=>{
  const url = document.getElementById('novelUrl').value.trim();
  if(!url){ alert('Nh·∫≠p URL'); return; }
  
  const btn = document.getElementById('loadChaptersBtn');
  btn.classList.add('loading');
  btn.disabled = true;
  
  // Hide previous download button
  document.getElementById('downloadFinishedBtn').style.display = 'none';
  downloadUrl = null;
  
  log('‚è≥ ƒêang t·∫£i danh s√°ch ch∆∞∆°ng...');
  setStatus('ƒêang t·∫£i...', 'process');

  try{
    const res = await fetch('/chapters', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({url})
    });
    const data = await res.json();
    if(!res.ok){ 
      log('‚ùå ' + (data.error || 'L·ªói')); 
      setStatus('L·ªói', 'danger');
      return; 
    }
    const chapters = data.chapters || [];
    const startSel = document.getElementById('startSel');
    const endSel = document.getElementById('endSel');
    startSel.innerHTML = '';
    endSel.innerHTML = '';
    document.getElementById('totalCount').textContent = (data.total || chapters.length);
    
    chapters.forEach(c=>{
      const opt = document.createElement('option');
      opt.value = c.index;
      opt.text = `${c.index}. ${c.title}`;
      startSel.appendChild(opt.cloneNode(true));
      endSel.appendChild(opt.cloneNode(true));
    });

    if(chapters.length>0){
      document.getElementById('statsCard').style.display = 'flex';
      startSel.selectedIndex = 0;
      endSel.selectedIndex = chapters.length-1;
      document.getElementById('startBtn').disabled = false;
      log(`‚úÖ T√¨m th·∫•y ${chapters.length} ch∆∞∆°ng.`);
      setStatus('S·∫µn s√†ng', 'success');
    } else {
      log('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ch∆∞∆°ng.');
      setStatus('Tr·ªëng', 'warning');
    }
  }catch(err){
    log('‚ùå L·ªói khi load chapters: ' + err);
    setStatus('L·ªói k·∫øt n·ªëi', 'danger');
  } finally {
    btn.classList.remove('loading');
    btn.disabled = false;
  }
});

document.getElementById('startBtn').addEventListener('click', async ()=>{
  const url = document.getElementById('novelUrl').value.trim();
  if(!url){ alert('Nh·∫≠p URL'); return; }
  const start = document.getElementById('startSel').value;
  const end = document.getElementById('endSel').value;
  
  log('‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu ti·∫øn tr√¨nh t·∫£i v·ªÅ...');
  setStatus('ƒêang t·∫£i truy·ªán...', 'process');

  try{
    const res = await fetch('/start', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({url, start: parseInt(start), end: parseInt(end)})
    });
    const data = await res.json();
    if(!res.ok){ 
      log('‚ùå ' + (data.error || 'L·ªói start')); 
      setStatus('L·ªói', 'danger');
      return; 
    }
    currentJob = data.job_id;
    document.getElementById('stopBtn').disabled = false;
    document.getElementById('startBtn').disabled = true;
    document.getElementById('loadChaptersBtn').disabled = true;
    pollLogs();
  }catch(err){
    log('‚ùå L·ªói khi start: ' + err);
    setStatus('L·ªói', 'danger');
  }
});

document.getElementById('stopBtn').addEventListener('click', async ()=>{
  if(!currentJob) return;
  await fetch('/stop', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({job: currentJob})});
  log('‚èπÔ∏è Y√™u c·∫ßu d·ª´ng ƒë√£ ƒë∆∞·ª£c g·ª≠i.');
  setStatus('ƒêang d·ª´ng...', 'warning');
  document.getElementById('stopBtn').disabled = true;
});

document.getElementById('clearLogBtn').addEventListener('click', ()=>{ 
  document.getElementById('log').innerHTML = ''; 
});

async function pollLogs(){
  if(!currentJob) return;
  try{
    const res = await fetch('/logs?job=' + encodeURIComponent(currentJob));
    const data = await res.json();
    
    if(res.ok){
      if(data.download_url) {
        downloadUrl = data.download_url;
      }
      
      if(data.logs){
        for(const it of data.logs){
          if(it === '__DONE__'){
            log('‚úÖ Ho√†n th√†nh t·∫£i xu·ªëng!');
            setStatus('Ho√†n t·∫•t', 'success');
            currentJob = null;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('loadChaptersBtn').disabled = false;
            
            if(downloadUrl) {
              document.getElementById('downloadFinishedBtn').style.display = 'inline-flex';
            }
            return;
          }
          log(it);
        }
      }
    }
  }catch(e){
    log('‚ùå L·ªói poll logs: ' + e);
  }
  setTimeout(pollLogs, 1000);
}

document.getElementById('startSel').addEventListener('change', function(){
  const startVal = parseInt(this.value, 10);
  const endSel = document.getElementById('endSel');
  if(parseInt(endSel.value, 10) < startVal){
    endSel.value = String(startVal);
  }
});

document.getElementById('endSel').addEventListener('change', function(){
  const startVal = parseInt(document.getElementById('startSel').value, 10);
  const endVal = parseInt(this.value, 10);
  if(endVal < startVal){
    this.value = String(startVal);
  }
});
</script>
</body>
</html>
